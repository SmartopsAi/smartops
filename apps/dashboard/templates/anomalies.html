{% extends "base.html" %}

{% block title %}Anomaly Detection{% endblock %}

{% block content %}

<!-- ======================================================
   DETECTION SUMMARY
   ====================================================== -->
<div class="row g-4 mb-4">

    <!-- Detection State -->
    <div class="col-lg-4">
        <div class="card h-100 text-center">
            <div class="card-body d-flex flex-column justify-content-center">

                <div class="mb-3">
                    <svg width="36" height="36" viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="12" r="9"
                                stroke="currentColor" stroke-width="2"/>
                        <path d="M12 6v6l3 3"
                              stroke="currentColor" stroke-width="2"/>
                    </svg>
                </div>

                <div class="text-muted small text-uppercase">
                    Current Detection State
                </div>

                <div class="display-5 fw-bold my-2" id="score-display">
                    --
                </div>

                <span id="score-status" class="badge bg-secondary px-3 py-2">
                    Waitingâ€¦
                </span>

            </div>
        </div>
    </div>

    <!-- Model Metadata -->
    <div class="col-lg-8">
        <div class="card h-100">
            <div class="card-header d-flex align-items-center gap-2">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <rect x="4" y="4" width="16" height="16" rx="3"
                          stroke="currentColor" stroke-width="2"/>
                    <path d="M4 10h16" stroke="currentColor" stroke-width="2"/>
                </svg>
                Detection Model Status
            </div>

            <div class="card-body">
                <div class="row gy-3">

                    <div class="col-md-4">
                        <div class="text-muted small">Model</div>
                        <div class="fw-semibold" id="model-version">--</div>
                    </div>

                    <div class="col-md-4">
                        <div class="text-muted small">Window ID</div>
                        <div class="font-monospace" id="window-id">--</div>
                    </div>

                    <div class="col-md-4">
                        <div class="text-muted small">Last Updated</div>
                        <div id="last-updated">--</div>
                    </div>

                </div>
            </div>
        </div>
    </div>

</div>

<!-- ======================================================
   FEATURE ATTRIBUTION / EXPLAINABILITY
   ====================================================== -->
<div class="row">
    <div class="col-12">
        <div class="card">

            <div class="card-header d-flex align-items-center gap-2">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M4 19V5M10 19V9M16 19V3M22 19H2"
                          stroke="currentColor" stroke-width="2"/>
                </svg>
                Feature Contributions (Explainability)
            </div>

            <div class="card-body text-center">

                <canvas id="chart-features"
                        height="120"
                        class="d-none">
                </canvas>

                <div id="no-features-msg"
                     class="text-muted fst-italic small">
                    No anomalous feature contributions detected in the current window.
                </div>

            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
fetch('/api/anomalies')
  .then(response => response.json())
  .then(data => {

    /* ================= DETECTION STATE ================= */
    if (data.latest_event) {
      const score = data.latest_event.score;

      document.getElementById('score-display').innerText =
        score === 1.0 ? 'ANOMALY' : 'NORMAL';

      document.getElementById('model-version').innerText =
        data.latest_event.model || 'unknown';

      document.getElementById('last-updated').innerText =
        new Date(data.latest_event.ts * 1000).toLocaleString();

      const statusBadge = document.getElementById('score-status');

      if (score === 1.0) {
        statusBadge.className = 'badge bg-danger px-3 py-2';
        statusBadge.innerText = 'ANOMALY DETECTED';
      } else {
        statusBadge.className = 'badge bg-success px-3 py-2';
        statusBadge.innerText = 'NORMAL OPERATION';
      }
    }

    /* ================= FEATURE ATTRIBUTION ================= */
    const breakdown = data.feature_breakdown;

    document.getElementById('window-id').innerText =
      breakdown?.window_id || 'N/A';

    const chartEl = document.getElementById('chart-features');
    const msgEl = document.getElementById('no-features-msg');

    chartEl.classList.add('d-none');
    msgEl.classList.remove('d-none');

    if (breakdown?.top_features?.length > 0) {
      const labels = breakdown.top_features.map(f => f.name || 'unknown');
      const values = breakdown.top_features.map(f => Number(f.value ?? 0));

      chartEl.classList.remove('d-none');
      msgEl.classList.add('d-none');

      new Chart(chartEl, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            data: values,
            backgroundColor: '#009dd1',
            borderRadius: 6
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          scales: {
            x: {
              beginAtZero: true,
              grid: { display: false }
            },
            y: {
              grid: { display: false }
            }
          },
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: ctx => `Deviation: ${ctx.raw}`
              }
            }
          }
        }
      });
    }
  })
  .catch(err => {
    console.error("Anomalies fetch failed:", err);
  });
</script>
{% endblock %}
