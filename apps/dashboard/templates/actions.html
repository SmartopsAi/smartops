{% extends "base.html" %}

{% block title %}Orchestrator Actions{% endblock %}

{% block content %}

<div class="row g-4">

    <!-- ======================================================
         ACTION EXECUTION PANEL
         ====================================================== -->
    <div class="col-lg-5">
        <div class="card">

            <div class="card-header d-flex align-items-center gap-2">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M12 2l7 4v6c0 5-3 9-7 10-4-1-7-5-7-10V6l7-4z"
                          stroke="currentColor" stroke-width="2"/>
                </svg>
                Manual Trigger
            </div>

            <div class="card-body">
                <form id="actionForm">

                    <!-- Action Type -->
                    <div class="mb-3">
                        <label class="form-label">Action Type</label>
                        <select class="form-select"
                                id="actionType"
                                onchange="toggleReplicas()">
                            <option value="scale">Scale Deployment</option>
                            <option value="restart">Restart Deployment</option>
                        </select>
                    </div>

                    <!-- Namespace -->
                    <div class="mb-3">
                        <label class="form-label">Namespace</label>
                        <input type="text"
                               class="form-control"
                               id="targetNamespace"
                               value="smartops-dev">
                    </div>

                    <!-- Deployment -->
                    <div class="mb-3">
                        <label class="form-label">Deployment Name</label>
                        <input type="text"
                               class="form-control"
                               id="targetName"
                               placeholder="e.g., erp-simulator">
                    </div>

                    <!-- Replicas -->
                    <div class="mb-3" id="replicasField">
                        <label class="form-label">Target Replicas</label>
                        <input type="number"
                               class="form-control"
                               id="targetReplicas"
                               value="3"
                               min="0"
                               max="10">
                        <div class="form-text">
                            Guardrail enforced: maximum 10 replicas.
                        </div>
                    </div>

                    <hr>

                    <!-- Safety Switches -->
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input"
                               type="checkbox"
                               id="dryRun"
                               checked>
                        <label class="form-check-label" for="dryRun">
                            Dry Run (simulate only)
                        </label>
                    </div>

                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input"
                               type="checkbox"
                               id="policyCheck"
                               checked
                               disabled>
                        <label class="form-check-label" for="policyCheck">
                            Policy Check Required (enforced)
                        </label>
                    </div>

                    <!-- Execute -->
                    <button type="button"
                            class="btn btn-primary w-100"
                            onclick="submitAction()">
                        Execute Action
                    </button>

                </form>
            </div>
        </div>

        <!-- ======================================================
             EXECUTION RESULT
             ====================================================== -->
        <div class="card mt-3 d-none" id="resultCard">
            <div class="card-header d-flex align-items-center gap-2">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M4 4h16v16H4z"
                          stroke="currentColor" stroke-width="2"/>
                    <path d="M8 12h8"
                          stroke="currentColor" stroke-width="2"/>
                </svg>
                Execution Result
            </div>
            <div class="card-body bg-light font-monospace small"
                 id="resultOutput">
                Waiting for response…
            </div>
        </div>

    </div>

    <!-- ======================================================
         ACTION HISTORY
         ====================================================== -->
    <div class="col-lg-7">
        <div class="card h-100">

            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center gap-2">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M3 12h18"
                              stroke="currentColor" stroke-width="2"/>
                        <path d="M12 3v18"
                              stroke="currentColor" stroke-width="2"/>
                    </svg>
                    Recent Actions
                </div>
                <span class="badge bg-secondary">Live</span>
            </div>

            <div class="card-body p-0">
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Type</th>
                            <th>Target</th>
                            <th>Status</th>
                            <th>Verification</th>
                        </tr>
                    </thead>
                    <tbody id="actionsTableBody">
                        <tr>
                            <td colspan="5"
                                class="text-center text-muted py-4">
                                Actions execute in real time.
                                Full audit is available under
                                Policies & Verification.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

        </div>
    </div>

</div>

{% endblock %}

{% block scripts %}
<script>
    // Toggle Replicas Field visibility based on Action Type
    function toggleReplicas() {
        const type = document.getElementById('actionType').value;
        const field = document.getElementById('replicasField');
        field.style.display = (type === 'scale') ? 'block' : 'none';
    }

    // Handle Form Submission
    async function submitAction() {
        const btn = document.querySelector('button');
        const output = document.getElementById('resultOutput');
        const card = document.getElementById('resultCard');

        btn.disabled = true;
        btn.innerText = "Processing…";
        card.classList.remove('d-none');
        output.innerText = "Sending request to Orchestrator…";

        const payload = {
            action: document.getElementById('actionType').value,
            namespace: document.getElementById('targetNamespace').value,
            name: document.getElementById('targetName').value,
            replicas: parseInt(document.getElementById('targetReplicas').value),
            dry_run: document.getElementById('dryRun').checked
        };

        try {
            const response = await fetch('/api/actions/trigger', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            let data;
            const contentType = response.headers.get("content-type");

            if (contentType && contentType.includes("application/json")) {
                data = await response.json();
            } else {
                throw new Error("Server returned non-JSON response");
            }

            output.innerText = JSON.stringify(data, null, 2);

            if (data.status === 'success') {
                output.className =
                    "card-body bg-success bg-opacity-10 text-success font-monospace small";
            } else {
                output.className =
                    "card-body bg-danger bg-opacity-10 text-danger font-monospace small";
            }

        } catch (error) {
            output.innerText = "Error: " + error.message;
        } finally {
            btn.disabled = false;
            btn.innerText = "Execute Action";
        }
    }
</script>
{% endblock %}
