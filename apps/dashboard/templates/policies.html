{% extends "base.html" %}

{% block title %}Policy Engine Audit{% endblock %}

{% block content %}

<!-- ======================================================
   KPI STRIP
   ====================================================== -->
<div class="row g-4 mb-4">

    <!-- Allowed -->
    <div class="col-xl-3 col-md-6">
        <div class="card card-kpi">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div>
                    <div class="text-muted small text-uppercase">Allowed Actions</div>
                    <div class="fs-3 fw-semibold mt-1" id="stat-allowed">--</div>
                </div>
                <div class="kpi-icon">
                    <svg width="26" height="26" viewBox="0 0 24 24" fill="none">
                        <path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" />
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Blocked -->
    <div class="col-xl-3 col-md-6">
        <div class="card card-kpi">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div>
                    <div class="text-muted small text-uppercase">Blocked Actions</div>
                    <div class="fs-3 fw-semibold mt-1 text-danger" id="stat-blocked">--</div>
                </div>
                <div class="kpi-icon">
                    <svg width="26" height="26" viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="2"/>
                        <path d="M8 12h8" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Most Triggered Guardrail -->
    <div class="col-xl-6 col-md-12">
        <div class="card h-100">
            <div class="card-body d-flex align-items-center justify-content-between">
                <div>
                    <div class="text-muted small text-uppercase">Most Triggered Guardrail</div>
                    <div class="fw-semibold fs-5 mt-1" id="top-guardrail">Loading…</div>
                    <div class="text-muted small mt-1">
                        Most frequently activated protection rule in recent decisions
                    </div>
                </div>
                <div class="kpi-icon">
                    <svg width="26" height="26" viewBox="0 0 24 24" fill="none">
                        <path d="M12 2l7 4v6c0 5-3 9-7 10-4-1-7-5-7-10V6l7-4z"
                              stroke="currentColor" stroke-width="2"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- ======================================================
   AUDIT TABLE
   ====================================================== -->
<div class="row">
    <div class="col-12">
        <div class="card">

            <div class="card-header d-flex align-items-center gap-2">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <rect x="4" y="4" width="16" height="16" rx="3"
                          stroke="currentColor" stroke-width="2"/>
                    <path d="M7 8h10M7 12h10M7 16h8"
                          stroke="currentColor" stroke-width="2"/>
                </svg>
                Decision Audit Log
            </div>

            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Policy ID</th>
                                <th>Decision</th>
                                <th>Reason</th>
                                <th>Guardrails Checked</th>
                            </tr>
                        </thead>
                        <tbody id="policy-table-body">
                            <tr>
                                <td colspan="5" class="text-center py-4 text-muted">
                                    Loading audit logs…
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    fetch('/api/policies')
    .then(response => response.json())
    .then(data => {
        const tbody = document.getElementById('policy-table-body');
        tbody.innerHTML = '';

        let allowed = 0;
        let blocked = 0;
        const guardrailCounts = {};

        data.decisions.forEach(d => {
            // Update Stats
            if (d.decision === 'allow') allowed++;
            if (d.decision === 'block') blocked++;

            // Count Guardrails
            d.guardrails.forEach(g => {
                if (g.triggered) {
                    guardrailCounts[g.name] = (guardrailCounts[g.name] || 0) + 1;
                }
            });

            // Render Row
            const tr = document.createElement('tr');
            const dateStr = d.ts ? new Date(d.ts).toLocaleString() : "-";
            const badgeClass =
                d.decision === 'allow' ? 'bg-success' :
                d.decision === 'block' ? 'bg-danger' :
                'bg-secondary';

            // Format guardrails
            const railsHtml = d.guardrails.map(g =>
                `<span class="badge ${g.triggered ? 'bg-warning text-dark' : 'bg-light text-muted border'} me-1 mb-1">${g.name}</span>`
            ).join('');

            tr.innerHTML = `
                <td class="small text-muted">${dateStr}</td>
                <td class="fw-semibold text-primary">${d.policy_id}</td>
                <td><span class="badge ${badgeClass} rounded-pill text-uppercase">${d.decision}</span></td>
                <td>${d.reason}</td>
                <td>${railsHtml}</td>
            `;
            tbody.appendChild(tr);
        });

        // Update Stats UI
        document.getElementById('stat-allowed').innerText = allowed;
        document.getElementById('stat-blocked').innerText = blocked;

        // Find top guardrail
        const top =
            Object.keys(guardrailCounts).length === 0
                ? "None"
                : Object.keys(guardrailCounts).reduce(
                    (a, b) => guardrailCounts[a] > guardrailCounts[b] ? a : b
                );

        document.getElementById('top-guardrail').innerText = top;
    })
    .catch(err => {
        console.error(err);
        document.getElementById('policy-table-body').innerHTML =
            '<tr><td colspan="5" class="text-center text-danger py-4">Failed to load policy data. (Ensure /api/policies endpoint exists)</td></tr>';
    });
</script>
{% endblock %}
